# 作業ログ 2025-12-11

## 実施済み作業

### 1. フォーム改修（index.php）
**完了日時**: 2025-12-11

**変更内容**:
- セクション2（リファーラル）削除
- セクション3（メンバー情報）削除
- 新セクション2：シェアストーリー追加（ラジオボタンのみ）
- 新セクション3：エデュケーション追加（ラジオボタン + ファイルアップロード）

**追加したJavaScript関数**:
```javascript
function setupEducationFileUpload() {
  // エデュケーションファイルアップロードの動的制御
  // ピッチプレゼンターと同様の仕組み
}
```

### 2. api_save.php 完全修正
**ステータス**: ✅ 100%完了

**完了部分**:
- $baseData配列の修正（is_share_story追加）
- エデュケーションファイルバリデーション追加
- リファーラル処理削除
- 監査ログ更新
- saveToDatabase()関数の更新（シグネチャ変更、エデュケーションファイル対応）
- リファーラルINSERTコード削除
- sendEmailNotification()関数の更新（新フィールド対応）
- メール本文HTMLの更新（リファーラル・メンバー情報削除、プレゼンター情報追加）
- BNI公式カラー (#D00C24) に統一

### 3. file_upload_helper.php 更新
**ステータス**: ✅ 完了

**追加内容**:
- EDUCATION_UPLOAD_DIR定数追加
- saveEducationFile()関数追加
- deleteEducationFile()関数追加
- data/educationディレクトリ作成

### 3. 座席表スライド確認
**ファイル**: `/Users/yamadaren/Downloads/25_12_12_57回宗麟_定例会.ppt  .pdf`
**確認済みスライド**: 7枚目

**内容**:
- 座席表（シーティングチャート）
- テーブル数: 8個（A, B, C, D, E, F, G, H）
- 各テーブルにメンバー名が配置
- 特別エリア: ポーチタイム、スクリーンなど

**要件**: 管理者画面で編集可能にする

## 未完了タスク（Todoリスト）

1. ✅ api_save.phpを更新（教育・シェアストーリー対応） - **完了**
2. ⏳ ビデオ対応実装（ピッチ・教育プレゼン用）
3. ⏳ 座席表編集機能を管理者画面に追加
4. ✅ サンクスメールを更新（新項目対応） - **完了**
5. ⏳ スライド生成を更新（シェアストーリー・教育追加）
6. ⏳ 管理者専用リファーラル金額入力ページ作成
7. ⏳ 2パターンスライド実装（月初 vs 通常）
8. ⏳ マニュアルページ（manual.php）を最新状態に更新
9. ⏳ 変更をテスト＆デプロイ

## ビデオ対応の推奨案

**推奨**: 両方対応（直接アップロード + YouTube埋め込み）

**理由**:
- 柔軟性: 短い動画は直接アップロード、長い動画はYouTube
- 実装コスト低: 既存のPDFアップロード機能を拡張
- サーバー負荷分散: 大きいファイルはYouTube CDN利用

**実装イメージ**:
```
ピッチプレゼンテーション担当ですか？
○ はい（ファイルまたはYouTube URLをアップロードします）
  → ファイルをアップロード: [ファイル選択] PDF/PowerPoint/MP4/WebM (最大100MB)
  または
  → YouTube URL: [テキスト入力] https://www.youtube.com/watch?v=...
○ いいえ
```

## 座席表編集機能 - 確定仕様

**確認済み要件**:

1. **座席配置**: メンバーの配置が変わる（週ごとまたは必要に応じて変更）
2. **編集インターフェース**: 高度版（ドラッグ&ドロップで自由配置）
3. **テーブル数**: 固定8テーブル（A, B, C, D, E, F, G, H）
4. **特別エリア**: 固定でOK（ポーチタイム、スクリーンは固定位置）

**実装方針**:

- **データ保存**: `data/seating_chart.json` （必要に応じて更新）
- **管理画面**: `admin/seating.php`
- **UI**: ドラッグ&ドロップ対応（JavaScript: interact.js または SortableJSを使用）
- **メンバーリスト**: `data/members.json` から取得
- **スライド生成**: `assets/js/svg-slide-generator.js` で座席表SVGを動的生成

**データ構造例**:
```json
{
  "last_updated": "2025-12-11 15:30:00",
  "tables": {
    "A": {
      "positions": [
        {"position": "top", "member_name": "鷺山佳子"},
        {"position": "right", "member_name": "高橋晃大"},
        {"position": "bottom-right", "member_name": "河野里保"},
        {"position": "bottom-left", "member_name": "渡邉美由紀"},
        {"position": "left", "member_name": "伊東"},
        {"position": "top-left", "member_name": "吉岡彩耶加"},
        {"position": "top-right", "member_name": "高野"}
      ]
    },
    "B": {...},
    ...
  },
  "special_areas": {
    "porch_time": {"position": "top-left", "label": "ポーチタイム"},
    "screen": {"position": "top-center", "label": "スクリーン"},
    "top_right_names": ["山本", "花田", "佳子", "野口", "花本", "山本"]
  }
}
```

## 技術メモ

### ファイル構造
```
/Users/yamadaren/Movies/claude-code-projects/yojitu.com/bni-slide-system/
├── index.php (フォーム - 修正完了)
├── api_save.php (バックエンド - 修正中)
├── manual.php (マニュアル - 更新必要)
├── data/
│   ├── seating_chart.json (座席表データ - 新規作成予定)
│   └── members.json (メンバー情報)
├── admin/
│   ├── edit.php (既存編集画面)
│   ├── referrals.php (リファーラル金額入力 - 新規作成予定)
│   └── seating.php (座席表編集 - 新規作成予定)
└── assets/
    └── js/
        └── svg-slide-generator.js (スライド生成 - 更新必要)
```

### データベーススキーマ変更予定

```sql
ALTER TABLE survey_data ADD COLUMN is_share_story INTEGER DEFAULT 0;
ALTER TABLE survey_data ADD COLUMN is_education_presenter INTEGER DEFAULT 0;
ALTER TABLE survey_data ADD COLUMN education_file_path TEXT;
```

### PDFからスライド画像変換コマンド

```bash
python3 << 'EOF'
from pdf2image import convert_from_path
images = convert_from_path(
    "/Users/yamadaren/Downloads/25_12_12_57回宗麟_定例会.ppt  .pdf",
    first_page=7,
    last_page=7,
    dpi=150
)
images[0].save("slide_07.png", 'PNG')
EOF
```

## 次のステップ

1. 座席表編集機能の仕様確認（AskUserQuestion使用）
2. api_save.phpの残り60%を完成
3. ビデオ対応実装
4. スライド生成ロジック更新
5. マニュアルページ更新
6. 全体テスト＆デプロイ

## 進捗状況（16:45更新）

### 完了したタスク
✅ データベーススキーマ更新（is_share_story, is_education_presenter等追加）
✅ api_save.php完全修正（新フィールド対応、メール通知更新）
✅ file_upload_helper.php更新（エデュケーションファイル保存機能追加）
✅ api_load.php更新（シェアストーリー・エデュケーションプレゼンター情報取得関数追加）
✅ assets/js/slide.js部分修正（新プレゼンター情報を受け取るように変更）

### 進行中のタスク
🔄 スライド生成を更新（svg-slide-generator.jsの修正が必要）
   - generateSVGSlides関数のシグネチャ更新が必要
   - シェアストーリースライドの追加が必要
   - エデュケーションスライドの追加が必要

### 残りのタスク
⏳ ビデオ対応実装（ピッチ・教育プレゼン用）
⏳ 座席表編集機能を管理者画面に追加
⏳ 管理者専用リファーラル金額入力ページ作成
⏳ 2パターンスライド実装（月初 vs 通常）
⏳ マニュアルページ（manual.php）を最新状態に更新
⏳ 全体テスト＆デプロイ

## 次回再開時の作業

1. **svg-slide-generator.jsの修正**（最優先）
   ```javascript
   // 関数シグネチャを変更
   async function generateSVGSlides(data, stats, slideDate = '', pitchPresenter = null, shareStoryPresenter = null, educationPresenter = null, slideConfig = null) {

   // シェアストーリースライドを追加（ピッチスライドの後）
   if (shareStoryPresenter) {
     slides.push(createShareStorySlide(shareStoryPresenter));
   }

   // エデュケーションスライドを追加（シェアストーリーの後）
   if (educationPresenter) {
     slides.push(createEducationSlide(educationPresenter));
   }
   ```

2. **スライドテンプレート関数を作成**
   - `createShareStorySlide()` 関数
   - `createEducationSlide()` 関数

3. **動作確認とデバッグ**

---
**最終更新**: 2025-12-11 16:45
**担当**: Claude Code
**ブランチ**: feature/data-foundation
**ステータス**: WiFi切断前に一時保存
