# äººæ°—è¨˜äº‹æ©Ÿèƒ½ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€GA4 APIã‚’ä½¿ã£ãŸäººæ°—è¨˜äº‹æ©Ÿèƒ½ã®è¨­å®šæ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ğŸ“ æ¦‚è¦

- **å®Œå…¨ç„¡æ–™**: Google Analytics 4 APIã¯ç„¡æ–™ã§ä½¿ç”¨ã§ãã¾ã™
- **è‡ªå‹•æ›´æ–°**: cronã§å®šæœŸå®Ÿè¡Œã™ã‚‹ã“ã¨ã§è‡ªå‹•çš„ã«äººæ°—è¨˜äº‹ãŒæ›´æ–°ã•ã‚Œã¾ã™
- **æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿**: GA4ã®å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸæ­£ç¢ºãªäººæ°—è¨˜äº‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### 1. Google Cloud Platformã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ

#### 1.1 GCPã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹
https://console.cloud.google.com/

#### 1.2 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆã¾ãŸã¯æ—¢å­˜ã®ã‚‚ã®ã‚’é¸æŠï¼‰
1. ç”»é¢ä¸Šéƒ¨ã®ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠã€ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œæ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ï¼ˆä¾‹: yojitu-analyticsï¼‰
4. ã€Œä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 1.3 Google Analytics Data API ã‚’æœ‰åŠ¹åŒ–
1. å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã‚’é¸æŠ
2. æ¤œç´¢ãƒãƒ¼ã§ã€ŒGoogle Analytics Data APIã€ã‚’æ¤œç´¢
3. ã€ŒGoogle Analytics Data APIã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã€Œæœ‰åŠ¹ã«ã™ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 1.4 ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ
1. å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒAPIã¨ã‚µãƒ¼ãƒ“ã‚¹ã€â†’ã€Œèªè¨¼æƒ…å ±ã€ã‚’é¸æŠ
2. ã€Œèªè¨¼æƒ…å ±ã‚’ä½œæˆã€â†’ã€Œã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ï¼ˆä¾‹: ga4-readonlyï¼‰
4. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰ã‚’ç¢ºèª
5. ã€Œä½œæˆã—ã¦ç¶šè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. ãƒ­ãƒ¼ãƒ«ã¯è¨­å®šä¸è¦ï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰
7. ã€Œå®Œäº†ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 1.5 JSONã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
1. ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œã‚­ãƒ¼ã€ã‚¿ãƒ–ã‚’é¸æŠ
3. ã€Œéµã‚’è¿½åŠ ã€â†’ã€Œæ–°ã—ã„éµã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ã‚­ãƒ¼ã®ã‚¿ã‚¤ãƒ—ã§ã€ŒJSONã€ã‚’é¸æŠ
5. ã€Œä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯
6. JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™

**é‡è¦**: ã“ã®JSONãƒ•ã‚¡ã‚¤ãƒ«ã¯ç§˜å¯†éµã‚’å«ã‚€ãŸã‚ã€å®‰å…¨ã«ç®¡ç†ã—ã¦ãã ã•ã„ã€‚

### 2. GA4ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’è¿½åŠ 

#### 2.1 Google Analytics 4ã«ã‚¢ã‚¯ã‚»ã‚¹
https://analytics.google.com/

#### 2.2 ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«æ¨©é™ã‚’ä»˜ä¸
1. å·¦ä¸‹ã®ã€Œç®¡ç†ã€ï¼ˆæ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ã€ã‚’é¸æŠ
3. å³ä¸Šã®ã€Œ+ã€â†’ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«å†…ã® `client_email` ã®å€¤ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘
   - ä¾‹: `ga4-readonly@yojitu-analytics.iam.gserviceaccount.com`
5. å½¹å‰²ã§ã€Œé–²è¦§è€…ã€ã‚’é¸æŠ
6. ã€Œè¿½åŠ ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

#### 2.3 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£IDã‚’ç¢ºèª
1. ã€Œç®¡ç†ã€â†’ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è¨­å®šã€ã‚’é¸æŠ
2. ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£IDã€ã‚’ã‚³ãƒ”ãƒ¼
   - ä¾‹: `123456789`

### 3. ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¨­å®š

#### 3.1 JSONã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ `blog/credentials.json` ã«ãƒªãƒãƒ¼ãƒ ã—ã¦é…ç½®ã—ã¾ã™ã€‚

```bash
mv ~/Downloads/yojitu-analytics-xxxxx.json /path/to/yojitu.com/blog/credentials.json
chmod 600 /path/to/yojitu.com/blog/credentials.json
```

#### 3.2 ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£IDã‚’è¨­å®š
`blog/update-popular-articles.php` ã‚’é–‹ã„ã¦ã€ä»¥ä¸‹ã®è¡Œã‚’ç·¨é›†ã—ã¾ã™ï¼š

```php
define('GA4_PROPERTY_ID', 'properties/YOUR_PROPERTY_ID');
```

â†“

```php
define('GA4_PROPERTY_ID', 'properties/123456789');  // å®Ÿéš›ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£IDã«ç½®ãæ›ãˆ
```

### 4. å‹•ä½œç¢ºèª

#### 4.1 ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
```bash
cd /path/to/yojitu.com/blog
php update-popular-articles.php
```

#### 4.2 æˆåŠŸã—ãŸå ´åˆã®å‡ºåŠ›ä¾‹
```
äººæ°—è¨˜äº‹ã®æ›´æ–°ã‚’é–‹å§‹ã—ã¾ã™...
ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ä¸­...
GA4 Data APIã‹ã‚‰äººæ°—è¨˜äº‹ã‚’å–å¾—ä¸­...
âœ… äººæ°—è¨˜äº‹ã®æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸï¼
å–å¾—ã—ãŸäººæ°—è¨˜äº‹æ•°: 10ä»¶
ä¿å­˜å…ˆ: /path/to/yojitu.com/blog/data/popular-articles.json
```

#### 4.3 ãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã§ç¢ºèª
- ãƒ–ãƒ­ã‚°ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸: https://yojitu.com/blog/
- ãƒ–ãƒ­ã‚°è©³ç´°ãƒšãƒ¼ã‚¸: https://yojitu.com/blog/detail.php?slug=xxx

ã€Œäººæ°—ã®è¨˜äº‹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™ï¼

### 5. cronã§è‡ªå‹•å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰

æ¯æ—¥åˆå‰3æ™‚ã«è‡ªå‹•å®Ÿè¡Œã™ã‚‹è¨­å®šï¼š

```bash
crontab -e
```

ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```cron
0 3 * * * cd /path/to/yojitu.com/blog && php update-popular-articles.php >> /path/to/yojitu.com/blog/logs/popular-articles.log 2>&1
```

ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆï¼š

```bash
mkdir -p /path/to/yojitu.com/blog/logs
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: credentials.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“

**åŸå› **: JSONã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
```bash
ls -la blog/credentials.json
```
ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### ã‚¨ãƒ©ãƒ¼: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ

**åŸå› **:
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®JSONã‚­ãƒ¼ãŒæ­£ã—ããªã„
- APIãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ãªã„

**è§£æ±ºæ–¹æ³•**:
1. Google Cloud Consoleã§Google Analytics Data APIãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
2. credentials.jsonã®å†…å®¹ãŒæ­£ã—ã„ã‹ç¢ºèª

### ã‚¨ãƒ©ãƒ¼: GA4 Data APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ

**åŸå› **:
- ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£IDãŒé–“é•ã£ã¦ã„ã‚‹
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«GA4ã®é–²è¦§æ¨©é™ãŒãªã„

**è§£æ±ºæ–¹æ³•**:
1. `GA4_PROPERTY_ID` ã®å€¤ã‚’ç¢ºèª
2. Google Analytics 4ã®ã€Œãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†ã€ã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é–²è¦§æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª

### äººæ°—è¨˜äº‹ãŒè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **:
- `popular-articles.json` ã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„
- éå»30æ—¥é–“ã«ãƒ–ãƒ­ã‚°è¨˜äº‹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒãªã„

**è§£æ±ºæ–¹æ³•**:
1. `blog/data/popular-articles.json` ã®å†…å®¹ã‚’ç¢ºèª
2. è¨˜äº‹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå°‘ãªã„å ´åˆã¯ã€ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã§ãã¾ã™

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿å½¢å¼

`blog/data/popular-articles.json` ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼š

```json
{
  "updated_at": "2025-11-24 03:00:00",
  "period": "éå»30æ—¥é–“",
  "articles": [
    {
      "id": 110,
      "slug": "homepage-accounting-budget",
      "page_views": 1250,
      "users": 980
    }
  ]
}
```

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### credentials.json ã®ä¿è­·

**å¿…é ˆ**: credentials.json ã‚’gitã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ï¼

`.gitignore` ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```bash
echo "blog/credentials.json" >> .gitignore
```

### ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³

```bash
chmod 600 blog/credentials.json
chmod 755 blog/update-popular-articles.php
```

## ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### è¡¨ç¤ºã™ã‚‹è¨˜äº‹æ•°ã‚’å¤‰æ›´

`blog/update-popular-articles.php` ã®ä»¥ä¸‹ã®è¡Œã‚’ç·¨é›†ï¼š

```php
define('TOP_N', 10); // 10 â†’ ä»»æ„ã®æ•°ã«å¤‰æ›´
```

`blog/includes/popular-articles.php` ã®ä»¥ä¸‹ã®è¡Œã‚‚ç·¨é›†ï¼š

```php
if (count($popular_posts) >= 5) {  // 5 â†’ ä»»æ„ã®æ•°ã«å¤‰æ›´
```

### é›†è¨ˆæœŸé–“ã‚’å¤‰æ›´

`blog/update-popular-articles.php` ã®ä»¥ä¸‹ã®éƒ¨åˆ†ã‚’ç·¨é›†ï¼š

```php
'dateRanges' => [
    [
        'startDate' => '30daysAgo',  // 7daysAgo, 90daysAgo ãªã©
        'endDate' => 'today'
    ]
]
```

## ğŸ“š å‚è€ƒè³‡æ–™

- [Google Analytics Data API ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developers.google.com/analytics/devguides/reporting/data/v1)
- [ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¤ã„ã¦](https://cloud.google.com/iam/docs/service-accounts)
- [GA4 ãƒ‡ã‚£ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema)

## ğŸ‰ å®Œäº†

ã“ã‚Œã§äººæ°—è¨˜äº‹æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼

æ¯æ—¥è‡ªå‹•çš„ã«äººæ°—è¨˜äº‹ãŒæ›´æ–°ã•ã‚Œã€ãƒ–ãƒ­ã‚°ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
