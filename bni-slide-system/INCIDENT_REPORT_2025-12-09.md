# インシデント報告 - 2025年12月9日 全ページ500エラー

**発生日時**: 2025年12月9日 15:00頃
**影響範囲**: 全PHPページが500エラー
**復旧時刻**: 2025年12月9日 15:30頃
**ダウンタイム**: 約30分

---

## 📋 事象サマリー

### 何が起きたか
- BNI Slide Systemの全PHPページが500 Internal Server Errorを返す状態になった
- index.php, my-data.php, profile.php など全ページが影響を受けた
- ユーザーは完全にシステムにアクセスできない状態

### 影響
- **全ユーザー**: システムに一切アクセスできない
- **期間**: 約30分間
- **データ損失**: なし

---

## 🔍 根本原因分析（RCA）

### 直接的な原因

**`.htaccess` に追加した以下のコードが原因：**

```apache
# ====================================
# Maintenance Mode (Auto Prepend)
# ====================================
<FilesMatch "\.php$">
    php_value auto_prepend_file "includes/maintenance_check.php"
</FilesMatch>
```

### なぜ500エラーになったか

1. **環境依存の大きい機能を使用**
   - `php_value auto_prepend_file` はPHPの実行方式（CGI/FastCGI/モジュール版）に強く依存
   - Xserverの環境設定との相性問題
   - ローカル開発環境では動作していたため、本番環境での動作を過信

2. **パスの解決問題**
   - 相対パス `includes/maintenance_check.php` が各PHPファイルのコンテキストから正しく解決されなかった
   - 絶対パス `/home/xs545151/.../includes/maintenance_check.php` でも動作しなかった
   - サーバーのPHP設定で `php_value` ディレクティブが制限されている可能性

3. **本番環境での未検証**
   - ローカルでの動作確認のみ
   - 本番環境でのテストなし
   - 段階的な展開（1ファイルだけなど）を実施せず、全ファイルに一括適用

### 根本的な原因（Why-Why分析）

1. **なぜ `.htaccess` で全ファイルに一括適用したか？**
   → 各PHPファイルに手動で `require_once` を書くのが面倒だと判断したため

2. **なぜ本番環境でテストしなかったか？**
   → ローカルで動いたので本番でも動くと想定したため（環境差異の認識不足）

3. **なぜロールバック計画がなかったか？**
   → `.htaccess` の変更がこれほど危険だという認識が不足していた

4. **なぜバックアップを取らなかったか？**
   → Gitで管理しているから大丈夫だという過信

5. **なぜリスク評価が不十分だったか？**
   → メンテナンスモード機能の実装を急ぎすぎた
   → 「便利な機能」を優先し、「安全性」を後回しにした

---

## 🚨 何がまずかったか（反省点）

### 技術的な判断ミス

1. **環境依存の高い機能を選択**
   - `php_value auto_prepend_file` は環境によって動作が異なる
   - より移植性の高い実装方法（手動 `require_once`）を選ぶべきだった

2. **段階的な展開を怠った**
   - 全ファイルに一括適用する前に、1ファイルでテストすべきだった
   - カナリアデプロイ（段階的展開）の概念を適用すべきだった

3. **本番環境での動作確認不足**
   - ローカル環境と本番環境の差異を過小評価
   - 本番環境でのテストを省略

### プロセス上の問題

4. **リスクアセスメント不足**
   - `.htaccess` 変更のリスクを軽視
   - 「最悪の場合、全サイトがダウンする」というリスクを想定していなかった

5. **バックアップ不足**
   - `.htaccess` の変更前にバックアップを取らなかった
   - ロールバック手順を準備していなかった

6. **変更管理の不備**
   - 重大な変更なのに、レビュープロセスなし
   - デプロイ前のチェックリストなし

### コミュニケーションの問題

7. **リスク説明不足**
   - Claude（AI）がユーザーに対して、この変更のリスクを十分に説明しなかった
   - 「本番環境で動かない可能性があります」という警告をしなかった

8. **代替案の提示不足**
   - より安全な実装方法（手動 `require_once`）を最初から提案すべきだった
   - 複数の選択肢を比較して、リスクと利便性のトレードオフを説明すべきだった

---

## ✅ 実施した復旧手順

### 緊急対応（実際に実施した内容）

1. **問題の特定**（5分）
   - ユーザーから「my-data.phpが500エラー」の報告
   - 他のページも確認し、全ページが500エラーと判明
   - Gitの最新コミット内容を確認

2. **原因の特定**（5分）
   - `.htaccess` の `auto_prepend_file` が原因と特定
   - ローカルで `.htaccess` の該当部分をコメントアウト

3. **修正のコミット＆プッシュ**（5分）
   - `.htaccess` の117-131行目をコメントアウト
   - Gitにコミット（commit 2fec167）
   - GitHubにプッシュ

4. **本番環境への反映**（15分）
   - 自動デプロイ設定がないことが判明
   - ユーザーが手動でFTP経由で `.htaccess` をアップロード
   - サイトの復旧を確認

### 修正内容

**変更ファイル**: `.htaccess`
**変更内容**: 以下の行をコメントアウト

```apache
# ====================================
# Maintenance Mode (Auto Prepend) - 一時的に無効化
# ====================================
# 全PHPファイルで自動的にメンテナンスチェックを実行
# 注意: auto_prepend_fileが500エラーを引き起こすため、一旦コメントアウト
# TODO: 後で別の方法で実装する（各ファイルに手動でrequire_once追加）
#<FilesMatch "\.php$">
#    # メンテナンスチェックを自動実行（絶対パス）
#    php_value auto_prepend_file "/home/xs545151/yojitu.com/public_html/bni-slide-system/includes/maintenance_check.php"
#</FilesMatch>
#
## 除外: maintenance.php と admin/maintenance_toggle.php
#<FilesMatch "(maintenance\.php|maintenance_toggle\.php)$">
#    php_value auto_prepend_file "none"
#</FilesMatch>
```

---

## 🛡️ 再発防止策

### 即座に実施する対策（短期）

#### 1. `.htaccess` 変更時の鉄則
- [ ] **必ずバックアップを取る**
  ```bash
  cp .htaccess .htaccess.backup_$(date +%Y%m%d_%H%M%S)
  ```
- [ ] **変更は小さく、段階的に**
  - 1つの変更 → 動作確認 → 次の変更
  - 全体に適用する前に、1ファイルでテスト

#### 2. 危険な変更のチェックリスト

**以下の変更は特に慎重に：**
- `.htaccess` の変更
- `php.ini` / `php_value` の変更
- データベーススキーマ変更
- 認証・セキュリティ関連

**必須手順：**
1. ローカルで動作確認
2. バックアップを取る
3. 本番で1ページだけテスト
4. 問題なければ全体に適用

#### 3. メンテナンスモードの正しい実装

**❌ 今回の失敗：.htaccessで自動実行**
```apache
php_value auto_prepend_file "..." # 環境依存が大きい
```

**✅ 安全な方法：各PHPファイルに手動追加**
```php
<?php
// 全PHPファイルの先頭に追加（maintenance.php以外）
require_once __DIR__ . '/includes/maintenance_check.php';
?>
```

**メリット：**
- 環境依存なし
- 動作が明示的で予測可能
- デバッグが容易

**デメリット：**
- 手動で各ファイルに追加する必要がある
- 新しいPHPファイルを作る際に忘れる可能性

→ デメリットよりもメリット（安全性）が圧倒的に大きい

#### 4. デプロイ前チェックリスト作成

以下のチェックリストを作成し、重大な変更時は必ず実施：

```markdown
## デプロイ前チェックリスト

### 事前準備
- [ ] バックアップを取得（DB、重要ファイル）
- [ ] 変更内容をドキュメント化
- [ ] ロールバック手順を準備

### テスト
- [ ] ローカル環境で動作確認
- [ ] 本番環境で1ファイル/1機能のみテスト
- [ ] エッジケースのテスト

### デプロイ
- [ ] 段階的にデプロイ（カナリアリリース）
- [ ] デプロイ後に主要ページの動作確認
- [ ] エラーログの監視

### 緊急時
- [ ] ロールバック手順を確認
- [ ] 関係者への連絡手段を確認
```

---

### 中期的な対策（1-3ヶ月以内）

#### 5. テスト環境の構築

**目的**: 本番環境と同じ設定でテストできる環境を用意

**実装方法（Xserverの場合）:**

**Option A: サブドメイン方式**
```
本番環境: https://yojitu.com/bni-slide-system/
テスト環境: https://test.yojitu.com/bni-slide-system/
```

**Option B: サブディレクトリ方式**
```
本番環境: https://yojitu.com/bni-slide-system/
テスト環境: https://yojitu.com/bni-slide-system-test/
```

**手順:**
1. Xserver管理画面でサブドメインを作成（または別ディレクトリ）
2. 本番環境と同じコードをデプロイ
3. データベースは別に用意（テストデータ使用）
4. Basic認証でアクセス制限

**運用:**
- 重大な変更はまずテスト環境で確認
- 問題なければ本番環境にデプロイ

#### 6. 自動デプロイの構築

**現状**: Gitにプッシュしても手動でFTPアップロードが必要

**理想**: Gitにプッシュ → 自動でテスト環境/本番環境にデプロイ

**実装方法（3つの選択肢）:**

##### Option A: GitHub Actions + FTP
```yaml
# .github/workflows/deploy.yml
name: Deploy to Xserver

on:
  push:
    branches:
      - main  # 本番環境
      - staging  # テスト環境

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: FTP Deploy
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /home/xs545151/yojitu.com/public_html/bni-slide-system/
```

**メリット:**
- GitHubの機能なので追加コストなし
- ワークフローをカスタマイズ可能
- デプロイ前にテストを実行可能

**デメリット:**
- 初期設定が必要
- FTPパスワードをGitHub Secretsに保存する必要

##### Option B: Xserverの自動デプロイ機能（あれば）

Xserverの管理画面で「Git連携」機能があるか確認：
- 一部のレンタルサーバーにはGitHub連携機能がある
- Webhookを設定するだけで自動デプロイ可能

**確認方法:**
1. Xserverの管理画面にログイン
2. 「Git」「デプロイ」「自動デプロイ」などのメニューを探す

##### Option C: Webhook + スクリプト

サーバーにWebhook受信スクリプトを設置：
```php
// deploy.php（サーバー上に設置）
<?php
$secret = 'your-secret-key';
$payload = file_get_contents('php://input');
$signature = $_SERVER['HTTP_X_HUB_SIGNATURE_256'] ?? '';

// 署名検証
if (hash_equals('sha256=' . hash_hmac('sha256', $payload, $secret), $signature)) {
    exec('cd /home/xs545151/yojitu.com/public_html/bni-slide-system && git pull origin main 2>&1', $output);
    echo json_encode(['status' => 'success', 'output' => $output]);
} else {
    http_response_code(403);
    echo json_encode(['status' => 'error', 'message' => 'Invalid signature']);
}
?>
```

GitHub側でWebhookを設定：
- Settings → Webhooks → Add webhook
- Payload URL: `https://yojitu.com/deploy.php`

**メリット:**
- 追加コストなし
- カスタマイズ可能

**デメリット:**
- セキュリティ設定が重要
- デプロイ失敗時のハンドリングが必要

#### 7. 監視・アラートの設定

**ツール例:**
- **UptimeRobot**（無料）: 5分ごとにサイトを監視、ダウン時にメール通知
- **Pingdom**（有料）: より詳細な監視
- **Google Cloud Monitoring**（無料枠あり）

**設定内容:**
- 主要ページ（index.php, my-data.php等）を5分ごとにチェック
- 500エラーが返ったら即座にメール通知
- 復旧したら通知

**効果:**
- 問題に気づくのが早くなる
- ダウンタイムを最小化

---

### 長期的な対策（3ヶ月以上）

#### 8. CI/CDパイプラインの整備

**目標**: コード変更からデプロイまでを完全自動化

```
コミット → 自動テスト → テスト環境デプロイ → 動作確認 → 本番デプロイ
```

**実装内容:**
1. ユニットテスト・インテグレーションテストの追加
2. GitHub ActionsでPR作成時に自動テスト
3. テスト通過後、自動でテスト環境にデプロイ
4. 手動承認後、本番環境にデプロイ
5. デプロイ後のヘルスチェック（500エラーがないか確認）
6. 異常検知時は自動ロールバック

#### 9. インフラストラクチャ as Code

`.htaccess` や設定ファイルをGitで管理：
- `.htaccess.template` をリポジトリに含める
- 環境変数で環境ごとの差異を吸収
- デプロイ時にテンプレートから生成

---

## 📚 今回の教訓（まとめ）

| # | 教訓 | 対策 |
|---|------|------|
| 1 | `.htaccess`は超危険 | 必ずバックアップ + 段階的テスト |
| 2 | 環境依存の機能は避ける | より移植性の高い実装を選ぶ |
| 3 | 本番でいきなり全体適用しない | 1ファイルでテスト → 全体 |
| 4 | ロールバック準備は必須 | バックアップ + 手順書 |
| 5 | リスク説明不足 | 危険な変更は事前に警告 |
| 6 | テスト環境が必要 | 本番と同じ環境でテスト |
| 7 | 自動デプロイがないと辛い | GitHub Actions等で自動化 |
| 8 | 監視がないと気づくのが遅い | UptimeRobot等で監視 |

---

## 📊 タイムライン

| 時刻 | イベント | 対応者 |
|------|---------|--------|
| 14:30頃 | メンテナンスモード機能を実装、Gitにプッシュ | Claude |
| 15:00頃 | ユーザーが「my-data.phpが500エラー」と報告 | ユーザー |
| 15:05 | 全ページが500エラーと判明 | Claude |
| 15:10 | 原因を `.htaccess` の `auto_prepend_file` と特定 | Claude |
| 15:15 | 修正をコミット＆プッシュ（commit 2fec167） | Claude |
| 15:20 | 自動デプロイがないことが判明 | - |
| 15:30 | ユーザーが手動でFTPアップロード、復旧完了 | ユーザー |

**ダウンタイム**: 約30分

---

## 🎯 アクションアイテム

### 即座に実施（今日中）
- [x] サイトの復旧
- [ ] `.htaccess` のバックアップを作成・保存
- [ ] デプロイ前チェックリストの作成
- [ ] このインシデントレポートの作成

### 1週間以内
- [ ] メンテナンスモードを安全な方法で再実装（各PHPファイルに `require_once`）
- [ ] 主要ページの動作確認テストケース作成
- [ ] UptimeRobotで監視設定

### 1ヶ月以内
- [ ] テスト環境の構築（サブドメインまたはサブディレクトリ）
- [ ] GitHub Actionsで自動デプロイ設定
- [ ] デプロイ手順書の作成

### 3ヶ月以内
- [ ] CI/CDパイプラインの整備
- [ ] 自動テストの追加
- [ ] ヘルスチェック＆自動ロールバックの実装

---

## 🤝 関係者

- **担当者**: Claude Code（AI）+ 余日様
- **影響を受けたユーザー**: 全BNIメンバー（ただしダウンタイム30分）
- **復旧作業**: 余日様

---

## 📝 参考資料

- [GitHubリポジトリ](https://github.com/[repo-name])
- [該当コミット 2fec167](https://github.com/[repo-name]/commit/2fec167)
- `.htaccess` のベストプラクティス
- PHP `auto_prepend_file` の環境依存性について

---

**作成日**: 2025年12月9日
**作成者**: Claude Code
**承認者**: 余日様
**次回レビュー**: 2025年12月16日

---

_このレポートは今後の開発の参考資料として保存してください。_
_同様のインシデントを二度と起こさないための教訓として活用してください。_
