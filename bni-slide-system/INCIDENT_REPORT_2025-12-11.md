# インシデント報告 - 2025年12月11日 スライド真っ白エラー

**発生日時**: 2025年12月11日
**影響範囲**: スライドページが真っ白に表示
**復旧時刻**: 2025年12月11日（数分後）
**ダウンタイム**: 約5分

---

## 📋 事象サマリー

### 何が起きたか
- `feature/data-foundation` ブランチを `main` にマージして本番環境にデプロイ
- https://yojitu.com/bni-slide-system/admin/slide.php が真っ白に表示
- ユーザーはスライドを閲覧できない状態

### 影響
- **全ユーザー**: スライドページにアクセスできない
- **期間**: 約5分間
- **データ損失**: なし

---

## 🔍 根本原因分析（RCA）

### 直接的な原因（推測）

**可能性1: slide_config.jsonのデプロイ漏れ**
- `api_load.php` が `slide_config.json` を読み込むように変更
- しかし、本番環境に `slide_config.json` がデプロイされていなかった可能性
- JavaScriptが `slide_config: null` を受け取り、処理でエラー→真っ白

**可能性2: CSSファイルが大きすぎる**
- `assets/css/slide.css` が2478行追加され、約3200行以上
- ファイルサイズが大きすぎて読み込みエラーが発生した可能性

**可能性3: JavaScriptの構文エラー**
- `assets/js/svg-slide-generator.js` に872行追加
- どこかに構文エラーがあり、JavaScriptの実行が停止

### なぜ起きたか

1. **本番環境での未検証**
   - ローカル環境でのみ動作確認
   - 本番環境でのテストなし
   - 段階的な展開を実施せず、全変更を一括マージ

2. **過去の教訓が活かされなかった**
   - INCIDENT_REPORT_2025-12-09.md に同様の問題が記録されていた
   - 「段階的にデプロイ」「本番環境でテスト」という教訓があったが、今回も同じミスを繰り返した

3. **変更規模が大きすぎた**
   - 全19フェーズを一度にマージ
   - 4,450行以上の変更
   - リスクアセスメント不足

---

## ✅ 実施した復旧手順

### 緊急対応（実際に実施した内容）

1. **問題の特定**（1分）
   - ユーザーから「真っ白になっている」の報告
   - 原因を特定する時間がないため、即座にロールバック決定

2. **ロールバック実行**（2分）
   - `git reset --hard 474db3d` でマージ前のコミットに戻す
   - `git push origin main --force` で強制プッシュ

3. **本番環境への反映**（2分）
   - GitHub Actions が自動デプロイ
   - 約1-3分後に復旧完了

4. **原因調査**（継続中）
   - 過去のインシデントレポートを確認
   - `slide_config.json` の有無を確認
   - JavaScriptのエラーハンドリングを確認

---

## 🛡️ 再発防止策

### 即座に実施する対策（短期）

#### 1. テスト環境の構築（最優先）

**現状**: 本番環境でいきなりテストしている

**目標**: テスト環境で十分に検証してから本番デプロイ

**実装方法**:
- サブディレクトリ方式: `https://yojitu.com/bni-slide-system-test/`
- 本番と同じデータ・設定でテスト
- テスト環境で問題なければ本番へ

#### 2. 段階的デプロイの徹底

**今回の失敗**: 全19フェーズを一度にマージ

**正しい方法**:
1. Phase 1のみ実装 → テスト → 本番デプロイ → 動作確認
2. Phase 2のみ実装 → テスト → 本番デプロイ → 動作確認
3. ... 繰り返し

**メリット**:
- 問題が起きても、どのフェーズが原因か特定しやすい
- ロールバックの範囲が小さい
- ダウンタイムを最小化

#### 3. デプロイ前チェックリストの徹底

**以下を必ず確認**:
- [ ] ローカル環境で動作確認
- [ ] `slide_config.json` などの設定ファイルがGitで管理されているか確認
- [ ] JavaScriptのコンソールエラーがないか確認
- [ ] CSSが正しく読み込まれているか確認
- [ ] テスト環境で動作確認（構築後）
- [ ] 本番デプロイ後、主要ページの動作確認

---

## 📊 タイムライン

| 時刻 | イベント | 対応者 |
|------|---------|--------|
| 不明 | `feature/data-foundation` を `main` にマージ | Claude |
| 不明 | GitHub Actions が自動デプロイ | 自動 |
| 不明 | ユーザーが「真っ白」と報告 | ユーザー |
| 不明 | 即座にロールバック決定 | Claude |
| 不明 | `git reset --hard 474db3d && git push --force` | Claude |
| 不明 | 復旧完了 | 自動 |

**ダウンタイム**: 約5分

---

## 🎯 次のステップ

### 1. 真の原因を特定（優先度：高）

**方法**:
- ブラウザの開発者ツール（F12）でJavaScriptのコンソールエラーを確認
- ネットワークタブでCSSの読み込みエラーを確認
- `slide_config.json` が本番環境に存在するか確認

### 2. テスト環境の構築（優先度：高）

**実装内容**:
- `https://yojitu.com/bni-slide-system-test/` を作成
- `feature/data-foundation` ブランチをテスト環境にデプロイ
- テスト環境で動作確認

### 3. 修正して再デプロイ（優先度：中）

**修正内容**:
- 原因が特定できたら修正
- テスト環境で十分に検証
- 本番環境にデプロイ

---

## 📚 今回の教訓（まとめ）

| # | 教訓 | 対策 |
|---|------|------|
| 1 | 過去のインシデントから学ばなかった | インシデントレポートを定期的に見直す |
| 2 | 本番でいきなりテストした | テスト環境を必ず構築する |
| 3 | 大規模変更を一度にマージした | Phase単位で段階的にデプロイ |
| 4 | ロールバック手順が機能した ✅ | Gitで管理しているので即座に復旧できた |

---

## 🤝 関係者

- **担当者**: Claude Code（AI）+ 余日様
- **影響を受けたユーザー**: スライド閲覧ユーザー
- **復旧作業**: Claude Code

---

**作成日**: 2025年12月11日
**作成者**: Claude Code

---

_このレポートは今後の開発の参考資料として保存してください。_
_同様のインシデントを二度と起こさないための教訓として活用してください。_
