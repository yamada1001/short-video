# ピッチセクション実装計画書

**作成日**: 2025年12月8日
**機能**: メンバーのピッチスライド埋め込み機能

---

## 📋 要件定義

### ユーザー要望
- スライドに「メンバーのピッチ」セクションを追加
- 毎週1名のメンバーがピッチを担当
- PowerPointファイル（またはPDF）をアップロードしてスライドに埋め込む

### 実装方針
1. アンケートフォームに「ピッチ担当者ですか？」質問項目を追加
2. YESの場合のみファイルアップロード欄を表示
3. PDF形式でのアップロードを推奨（PowerPoint→PDF変換はユーザー側で実施）
4. アップロードされたPDFをスライドに埋め込み表示

---

## 🎯 実装ステップ

### Phase 1: データベース設計
- [ ] `survey_data` テーブルにカラム追加
  - `is_pitch_presenter` (INTEGER, DEFAULT 0)
  - `pitch_file_path` (TEXT, NULL)
  - `pitch_file_original_name` (TEXT, NULL)
- [ ] マイグレーションスクリプト作成
  - `database/migrate_add_pitch.php`

### Phase 2: ファイル保存ディレクトリ作成
- [ ] `data/pitch/` ディレクトリ作成
- [ ] `data/pitch/.htaccess` 作成（直接アクセス禁止）
- [ ] パーミッション設定（707）

### Phase 3: ファイルアップロード共通処理
- [ ] `includes/file_upload_helper.php` 作成
  - ファイルタイプ検証（PDF, PPTX のみ許可）
  - ファイルサイズ制限（例: 10MB）
  - セキュリティチェック（ファイル名サニタイズ、MIMEタイプ確認）
  - ファイル保存処理

### Phase 4: フォーム修正
- [ ] `index.php` 修正
  - 「ピッチ担当者ですか？」ラジオボタン追加（YES/NO）
  - ファイルアップロード欄追加（条件付き表示）
  - JavaScriptで動的表示制御
  - `enctype="multipart/form-data"` 追加
- [ ] `assets/css/form.css` スタイル調整

### Phase 5: API修正（保存処理）
- [ ] `api_save.php` 修正
  - `is_pitch_presenter` フィールド受け取り
  - ファイルアップロード処理追加
  - ファイル保存先: `data/pitch/{week_date}_{user_id}.pdf`
  - `pitch_file_path`, `pitch_file_original_name` をデータベースに保存
  - 既存のピッチファイルがある場合は上書き確認

### Phase 6: API修正（読み込み処理）
- [ ] `api_load.php` 修正
  - ピッチ担当者のデータを抽出
  - `pitch_file_path` を含めてJSON返却
- [ ] `api_load_my_data.php` 修正
  - ピッチファイル情報を含める
- [ ] `api_update_my_data.php` 修正
  - ファイルアップロード処理追加

### Phase 7: スライド表示修正
- [ ] `assets/js/slide.js` 修正
  - ピッチセクションのスライド生成ロジック追加
  - PDFの埋め込み方法：
    - Option A: `<iframe src="pitch.pdf" width="100%" height="600px"></iframe>`
    - Option B: PDF.js で Canvas レンダリング
  - ピッチ担当者がいない場合はセクションを表示しない
- [ ] `assets/css/slide.css` 修正
  - ピッチスライドのスタイル追加
  - PDFビューアのスタイル調整

### Phase 8: 管理画面修正（オプション）
- [ ] `admin/edit.php` 修正
  - ピッチファイルの確認・削除機能
- [ ] `edit-my-data.php` 修正
  - マイデータ編集画面でのファイルアップロード対応

---

## 🔒 セキュリティ対策

### ファイルアップロードのセキュリティ
1. **ファイルタイプ検証**
   - 許可: `.pdf`, `.pptx`, `.ppt`
   - MIMEタイプチェック: `application/pdf`, `application/vnd.openxmlformats-officedocument.presentationml.presentation`

2. **ファイルサイズ制限**
   - 最大: 10MB

3. **ファイル名サニタイズ**
   - ユーザーが指定したファイル名を使わず、サーバー側で生成
   - 形式: `{week_date}_{user_id}_{timestamp}.pdf`

4. **保存先のアクセス制限**
   - `data/pitch/.htaccess` で直接アクセス禁止
   - PHPスクリプト経由でのみアクセス可能

5. **CSRF対策**
   - 既存のCSRFトークン機能を利用

6. **ファイル実行防止**
   - `.htaccess` で `php_flag engine off` 設定

---

## 📂 ファイル構成（修正後）

```
bni-slide-system/
├── database/
│   ├── schema.sql                    # 修正: カラム追加
│   └── migrate_add_pitch.php         # 新規: マイグレーション
├── data/
│   └── pitch/                        # 新規: ピッチファイル保存先
│       ├── .htaccess                 # 新規: アクセス制限
│       └── 2025-12-12_123.pdf        # 例: アップロードファイル
├── includes/
│   └── file_upload_helper.php        # 新規: ファイルアップロード共通処理
├── index.php                         # 修正: ピッチ担当質問 + ファイルアップロード
├── api_save.php                      # 修正: ファイルアップロード処理
├── api_load.php                      # 修正: ピッチファイル情報含む
├── api_load_my_data.php              # 修正: ピッチファイル情報含む
├── api_update_my_data.php            # 修正: ファイルアップロード処理
├── assets/
│   ├── css/
│   │   ├── form.css                  # 修正: フォームスタイル
│   │   └── slide.css                 # 修正: ピッチスライドスタイル
│   └── js/
│       └── slide.js                  # 修正: ピッチスライド生成ロジック
├── admin/
│   └── edit.php                      # 修正: ピッチファイル管理
└── edit-my-data.php                  # 修正: ファイルアップロード対応
```

---

## 🎨 UI/UX設計

### 1. アンケートフォーム（index.php）

```
┌─────────────────────────────────────┐
│ BNI週次アンケート                    │
├─────────────────────────────────────┤
│ お名前: [山田太郎        ]          │
│ メール: [yamada@example.com]        │
│ 出席状況: ○出席 ○欠席 ○代理出席    │
│                                     │
│ ◆ ピッチ担当者ですか？              │
│ ○ はい（次の会でピッチを担当します）│
│ ● いいえ                            │
│                                     │
│ ┌─────────────────────────┐       │
│ │ ⚠ ピッチ担当者の方へ      │       │
│ │                          │       │
│ │ ピッチ資料をアップロード  │       │
│ │ ［ファイルを選択］        │       │
│ │                          │       │
│ │ 対応形式: PDF（推奨）または │     │
│ │ PowerPoint (.pptx)       │       │
│ │ 最大サイズ: 10MB         │       │
│ └─────────────────────────┘       │
│                                     │
│ ビジター情報: ...                   │
│ リファーラル情報: ...               │
│                                     │
│ [送信]                              │
└─────────────────────────────────────┘
```

### 2. スライド表示（admin/slide.php）

```
┌─────────────────────────────────────┐
│          BNI 週次レポート            │
│        2025年12月12日（金）          │
└─────────────────────────────────────┘
    ↓ 次のスライド
┌─────────────────────────────────────┐
│       今週のビジター・リファーラル    │
│                                     │
│ [グラフ・データ表示]                 │
└─────────────────────────────────────┘
    ↓ 次のスライド
┌─────────────────────────────────────┐
│       メンバーのピッチ               │
│                                     │
│ 📊 山田太郎さん                      │
│                                     │
│ [PDFビューアまたはiframe]            │
│                                     │
└─────────────────────────────────────┘
    ↓ 次のスライド
┌─────────────────────────────────────┐
│       出席状況                       │
│ [データ表示]                         │
└─────────────────────────────────────┘
```

---

## 🧪 テストケース

### 1. ファイルアップロード
- [ ] PDF形式のファイルが正常にアップロードできる
- [ ] PPTX形式のファイルが正常にアップロードできる
- [ ] 10MB以下のファイルがアップロードできる
- [ ] 10MBを超えるファイルがエラーになる
- [ ] 不正なファイル形式（.exe, .zipなど）がエラーになる

### 2. ピッチ担当者の選択
- [ ] 「はい」を選択するとファイルアップロード欄が表示される
- [ ] 「いいえ」を選択するとファイルアップロード欄が非表示になる
- [ ] ファイルをアップロードせずに「はい」を選択するとエラーになる

### 3. スライド表示
- [ ] ピッチファイルがスライドに正しく埋め込まれる
- [ ] ピッチ担当者がいない週はピッチセクションが表示されない
- [ ] PDFが正しく表示される（全ページ閲覧可能）

### 4. データ更新
- [ ] マイデータ編集画面でピッチファイルを変更できる
- [ ] 古いピッチファイルが削除される

### 5. セキュリティ
- [ ] 直接URLアクセス（`/data/pitch/xxx.pdf`）がブロックされる
- [ ] CSRFトークンなしでアップロードできない
- [ ] 別ユーザーのピッチファイルにアクセスできない

---

## 📅 実装スケジュール（目安）

| Phase | 作業内容 | 所要時間 |
|-------|---------|---------|
| Phase 1 | データベース設計 | 30分 |
| Phase 2 | ディレクトリ作成 | 10分 |
| Phase 3 | ファイルアップロード共通処理 | 1時間 |
| Phase 4 | フォーム修正 | 1時間 |
| Phase 5 | API修正（保存） | 1.5時間 |
| Phase 6 | API修正（読み込み） | 1時間 |
| Phase 7 | スライド表示修正 | 2時間 |
| Phase 8 | 管理画面修正 | 1時間 |
| テスト | 総合テスト | 1時間 |
| **合計** | | **約9時間** |

---

## 🚀 実装後の拡張案

### 将来的な改善案
1. **PowerPoint自動変換**
   - サーバーにLibreOfficeをインストールし、PPTX→PDF自動変換

2. **プレビュー機能**
   - アップロード前にプレビュー表示

3. **複数ファイル対応**
   - 1週間に複数のピッチ担当者がいる場合に対応

4. **ピッチ履歴管理**
   - 過去のピッチ資料をアーカイブ表示

5. **コメント機能**
   - ピッチに対するフィードバックをコメントで追加

---

## 📞 質問事項（ユーザー確認）

実装前に確認が必要な項目：

1. **ファイル形式**
   - PDF形式のみでOKですか？
   - PowerPoint形式（PPTX）もサポートが必要ですか？

2. **ファイルサイズ**
   - 最大10MBで問題ありませんか？

3. **複数ページ対応**
   - PDFが複数ページある場合、全ページ表示しますか？
   - それとも1ページ目のみ表示しますか？

4. **スライド表示位置**
   - ピッチセクションはどの位置に表示しますか？
     - 案1: 最初（タイトルスライドの次）
     - 案2: 途中（ビジター・リファーラルの後）
     - 案3: 最後（出席状況の後）

5. **ピッチ担当者の管理**
   - ピッチ担当者は自己申告でOKですか？
   - それとも管理者が事前に指定しますか？

---

## ✅ 承認

- [ ] ユーザー承認
- [ ] 実装開始

---

**次のステップ**: ユーザー確認後、Phase 1から順次実装を開始します。
