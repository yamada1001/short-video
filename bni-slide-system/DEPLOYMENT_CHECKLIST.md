# デプロイチェックリスト - 必ず守ること

**作成日**: 2025年12月11日
**最終更新**: 2025年12月11日

---

## 🚨 重要：このチェックリストを必ず実行してください

このチェックリストは、過去のインシデント（INCIDENT_REPORT_2025-12-09.md、INCIDENT_REPORT_2025-12-11.md）から学んだ教訓をもとに作成されています。

**デプロイ前に全ての項目を確認しないと、本番環境が停止する可能性があります。**

---

## ✅ Phase 1: コード変更前の確認

### 1-1. 過去のインシデントレポートを確認
- [ ] `INCIDENT_REPORT_*.md` ファイルを全て読む
- [ ] 同じミスを繰り返していないか確認
- [ ] 過去の教訓を理解する

### 1-2. データベース変更の確認
- [ ] 新しいカラムを追加する場合、マイグレーションファイルを作成
- [ ] 新しいテーブルを追加する場合、マイグレーションファイルを作成
- [ ] マイグレーションファイルは `database/migrate_*.php` に配置

---

## ✅ Phase 2: コード変更後の確認

### 2-1. ローカル環境での動作確認
- [ ] ブラウザでページを開いて正常に表示されるか確認
- [ ] JavaScript コンソール（F12 → Console）にエラーがないか確認
- [ ] Network タブで全てのリソースが 200 OK で読み込まれているか確認

### 2-2. コードレビュー
- [ ] 未実装の関数を呼び出していないか確認
- [ ] CDN リソース（フォントなど）が有効か確認
- [ ] 外部 API が正常に動作するか確認

---

## ✅ Phase 3: コミット前の確認

### 3-1. Git コミット
- [ ] 変更内容を確認（`git diff`）
- [ ] 意図しない変更が含まれていないか確認
- [ ] コミットメッセージに変更内容を明確に記載

### 3-2. マイグレーションファイルの確認
- [ ] 新しいマイグレーションファイルがある場合、Git に追加されているか確認
- [ ] マイグレーションファイルが正しい場所（`database/`）にあるか確認

---

## ✅ Phase 4: デプロイ後の確認（最重要）

### 4-1. GitHub Actions のデプロイ完了確認
- [ ] GitHub リポジトリの「Actions」タブを開く
- [ ] 最新のワークフローが✅緑色で成功しているか確認
- [ ] デプロイが完了するまで待つ（通常2-3分）

### 4-2. 本番環境でのマイグレーション実行（データベース変更がある場合）
- [ ] 新しいマイグレーションファイルがある場合、以下の URL にアクセス:
  - `https://yojitu.com/bni-slide-system/database/migrate_add_youtube_url.php`
  - `https://yojitu.com/bni-slide-system/database/migrate_add_monthly_ranking.php`
  - その他の新しいマイグレーションファイル
- [ ] 「Migration completed successfully!」が表示されることを確認

### 4-3. 本番環境での動作確認（必須）
- [ ] **https://yojitu.com/bni-slide-system/admin/slide.php** を開く
- [ ] スライドが正常に表示されるか確認
- [ ] JavaScript コンソール（F12 → Console）にエラーがないか確認
- [ ] 以下のページも確認:
  - [ ] https://yojitu.com/bni-slide-system/index.php（アンケート入力）
  - [ ] https://yojitu.com/bni-slide-system/admin/edit.php（編集画面）
  - [ ] https://yojitu.com/bni-slide-system/admin/monthly_ranking.php（月間ランキング）

### 4-4. API の動作確認
- [ ] https://yojitu.com/bni-slide-system/api_list_weeks.php にアクセス
- [ ] JSON が正常に返ってくるか確認（エラーメッセージが表示されていないか）
- [ ] https://yojitu.com/bni-slide-system/api_load.php にアクセス
- [ ] JSON が正常に返ってくるか確認（「no such column」エラーがないか）

---

## 🚨 もし本番環境でエラーが出た場合

### 緊急対応手順

#### 1. 即座にロールバック
```bash
# 安定した最後のコミットに戻す
git log --oneline -10  # 安定版のコミットIDを確認
git reset --hard <安定版のコミットID>
git push origin main --force
```

#### 2. GitHub Actions の再デプロイを待つ（2-3分）

#### 3. 本番環境で正常動作を確認

#### 4. 問題を調査
- JavaScript コンソールのエラーを確認
- Network タブで 404 エラーがないか確認
- データベースのマイグレーションが実行されているか確認

---

## 📋 よくあるミスと対策

### ミス1: マイグレーションを実行し忘れる
**症状**:
```
no such column: youtube_url
```

**対策**:
- デプロイ後、必ずマイグレーションファイルにブラウザでアクセスする
- チェックリスト Phase 4-2 を必ず実行

---

### ミス2: スライドが真っ白になる
**症状**:
- スライドページが真っ白
- 目次だけ表示される

**原因**:
- JavaScript エラー
- API からデータが取得できない
- データベースマイグレーション未実行

**対策**:
- F12 → Console でエラーを確認
- api_load.php にアクセスしてエラーを確認
- マイグレーションを実行

---

### ミス3: 新しいファイルがデプロイされない
**症状**:
- 新しく作成したファイルが 404 エラー

**原因**:
- Git に追加していない
- GitHub Actions のデプロイ設定が間違っている

**対策**:
- `git add` でファイルを追加
- `git status` で確認
- GitHub Actions のワークフローを確認

---

## 🎯 このチェックリストの目的

1. **本番環境の停止を防ぐ**
2. **ユーザーへの影響を最小限にする**
3. **同じミスを繰り返さない**
4. **迅速な復旧を可能にする**

---

## 📚 関連ドキュメント

- [INCIDENT_REPORT_2025-12-09.md](./INCIDENT_REPORT_2025-12-09.md) - 1回目のインシデント
- [INCIDENT_REPORT_2025-12-11.md](./INCIDENT_REPORT_2025-12-11.md) - 2回目のインシデント
- [SESSION_STATUS_2025-12-11.md](./SESSION_STATUS_2025-12-11.md) - セッション状況

---

## ⚠️ 絶対に忘れてはいけないこと

### デプロイ後は必ず確認
**本番環境でマイグレーションを実行し、動作確認をする**

これを忘れると、スライドが真っ白になり、ユーザーに影響が出ます。

---

**最終更新**: 2025年12月11日
**作成者**: Claude Code
**承認者**: 余日様
